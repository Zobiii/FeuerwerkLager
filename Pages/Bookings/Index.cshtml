@page
@model FeuerwerkLager.Pages.Bookings.IndexModel
@{
    ViewData["Title"] = "Buchungen";
}

<section class="card mb-3">
    <div class="card-body">
        <h1 class="h5 mb-1">Artikel buchen</h1>
        <p class="text-muted mb-0">Umbuchung immer in Einzelstück-Logik (volle Einheiten + lose Stücke).</p>
    </div>
</section>

<div class="form-card">
    <form method="post">
        <div asp-validation-summary="All" class="validation-summary-errors mb-3"></div>

        <div class="form-grid two-columns">
            <div class="form-group">
                <label for="articleSelect">Artikel</label>
                <select asp-for="SelectedArticleId" class="form-select" id="articleSelect">
                    @foreach (var a in Model.Articles)
                    {
                        <option value="@a.Id">@a.Name (@a.Company)</option>
                    }
                </select>
            </div>

            <div class="form-group">
                <label for="fromLocationSelect">Von</label>
                <select asp-for="FromLocationId" class="form-select" id="fromLocationSelect">
                    <option value="">frei</option>
                    @foreach (var l in Model.Locations)
                    {
                        <option value="@l.Id">@l.Name</option>
                    }
                </select>
            </div>

            <div class="form-group">
                <label for="toLocationSelect">Nach</label>
                <select asp-for="ToLocationId" class="form-select" id="toLocationSelect">
                    <option value="">frei</option>
                    @foreach (var l in Model.Locations)
                    {
                        <option value="@l.Id">@l.Name</option>
                    }
                </select>
            </div>

            <div class="form-group">
                <label asp-for="FullUnitsToMove">Volle Einheiten</label>
                <input asp-for="FullUnitsToMove" class="form-control" type="number" id="fullUnitsInput" min="0" />
            </div>

            <div class="form-group">
                <label asp-for="LoosePiecesToMove">Lose Stücke</label>
                <input asp-for="LoosePiecesToMove" class="form-control" type="number" id="loosePiecesInput" min="0" />
                <small id="quantityHint" class="hint-text"></small>
            </div>
        </div>

        <div class="mt-3 d-flex gap-2">
            <button type="submit" class="btn btn-primary">Buchen</button>
            <a asp-page="/Index" class="btn btn-outline-secondary">Dashboard</a>
        </div>
    </form>
</div>

@section Scripts {
<script>
(function () {
    var availability = {
        @foreach (var kv in Model.AvailabilityPieces)
        {
            <text>"@kv.Key": @kv.Value,</text>
        }
    };
    var perUnitMap = {
        @foreach (var kv in Model.PiecesPerUnitMap)
        {
            <text>"@kv.Key": @kv.Value,</text>
        }
    };

    function updateHint() {
        var articleId = document.getElementById('articleSelect')?.value;
        var fromLocId = document.getElementById('fromLocationSelect')?.value;
        var hint = document.getElementById('quantityHint');
        var fullInput = document.getElementById('fullUnitsInput');
        var looseInput = document.getElementById('loosePiecesInput');

        if (!articleId || !hint) return;

        var key = articleId + '|' + (fromLocId === '' ? 'free' : fromLocId);
        var maxPieces = availability[key] || 0;
        var perUnit = perUnitMap[articleId] || 1;

        if (fullInput) fullInput.max = Math.floor(maxPieces / perUnit);
        if (looseInput) looseInput.max = Math.max(0, perUnit - 1);

        hint.textContent = 'Verfügbar: ' + maxPieces + ' Stück.';
    }

    document.getElementById('articleSelect')?.addEventListener('change', updateHint);
    document.getElementById('fromLocationSelect')?.addEventListener('change', updateHint);
    updateHint();
})();
</script>
}
